# è·å–é™„è¿‘å……ç”µæ¡©åˆ—è¡¨

è¯·æ±‚
```
curl 'https://appapi.lvcchong.com/appBaseApi/nearbyDeviceList?channelMessage=LVCC-WO-PH_2025.09.12_Tencent-H10'  -H 'Host: appapi.lvcchong.com'  -H 'Accept: */*'  -H 'Sec-Fetch-Site: same-site'  -H 'Accept-Language: zh-CN,zh-Hans;q=0.9'  -H 'Accept-Encoding: gzip, deflate'  -H 'Sec-Fetch-Mode: cors'  -H 'token: eyJhbGciOiJSUzI1NiIsImtpZCI6ImJmYmE3ZjNkZGQ3YTRlMmI4NjJjZDIyMGY3NWZhMWI5In0.eyJqdGkiOiI2d2NwVVhMcDVLVXdnYjV0c2lxQ1J3IiwiaWF0IjoxNzYwMTY1MzE1LCJleHAiOjE3NjAxNjUzNDUsIm5iZiI6MTc2MDE2NTI1NSwic3ViIjoiMSIsImF1ZCI6IklfRE9OT1RfQ0FSRSIsInVzZXJJZCI6Ijc3MDMzMTIxIn0.IXdmjYaP9Hr8XVUqQ0NTsr2qjcCo1z2rqxU28HLQvQ1pMeVC-1MiYoC2xvUdFQb9G-P-VHck1JVNEVNnWQxBTSy0R9vgJ5KbumM77n2Z6lG5DZ1wrnHVboEefIA1Vwe5RCd3ALGAr2hv13N85_Tz_MvwCgebWUcLEaa6PjfCVKlrheLlIn2DRczd728_WEgrNZm8ytQ19JkrxGjgvjEJn1tencHzObfDmMDuNcnH6OPwcFukoheRKDs_IFmj_AshQJu_eVmpyfGreA4YLo5J0gM6a4vFYw_QJOXt6Ta_tJY36ExT6gsZjJ29VHdwcCjEQZjteSk6Olui-4LNDYxheg'  -H 'Origin: https://h5.lvcchong.com'  -H 'Content-Length: 77'  -H 'User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 18_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.63(0x18003f2f) NetType/WIFI Language/zh_CN'  -H 'Referer: https://h5.lvcchong.com/'  -H 'Connection: keep-alive'  -H 'Content-Type: application/x-www-form-urlencoded'  -H 'Sec-Fetch-Dest: empty'   --data 'positioningFlag=1&deviceFamily=0&lat=40.043910&lng=116.283760&name=&mapType=2' --compressed 
```

å“åº”
```json
{
    "code": 200,
    "data": [
        {
            "id": 773288,
            "name": "ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ2å·æ¡©",
            "simId": "863060079195715",
            "simProvide": null,
            "ownerId": 1315,
            "portNumber": 20,
            "freePortCount": 8,
            "protocolType": null,
            "provinceId": 1,
            "provinceName": null,
            "cityId": 2,
            "cityName": null,
            "countyId": 1692,
            "countyName": null,
            "estateId": 177063,
            "estateName": null,
            "factory": null,
            "online": 1,
            "status": 1,
            "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæ—ºç§‘ä¸œè·¯",
            "chargePriceId": 143131,
            "chargePriceName": null,
            "payWay": null,
            "place": null,
            "inTime": 1734322303625,
            "updateTime": null,
            "lat": 40.044545,
            "lng": 116.282972,
            "hardwareId": null,
            "deviceType": 96,
            "deviceFamily": 0,
            "electricType": 0,
            "cooperationType": 99,
            "settlementType": null,
            "estateContact": null,
            "estateTel": null,
            "iccid": null,
            "moduleType": null,
            "occupancyFee": null,
            "priceStandardId": null,
            "mainVersion": null,
            "userDeviceType": null,
            "userDeviceTypeName": null,
            "maxWatt": null,
            "addEntranceType": null,
            "switchCabInfoDTO": null,
            "queryPriceStandardResult": null,
            "isMjDevice": null,
            "routeType": 4,
            "vdNo": null,
            "productSn": null,
            "investmentMoney": null,
            "isUnion": null,
            "totalAmount": null,
            "unionServiceFee": null,
            "serviceFeeStatus": null,
            "serviceFeeTime": null,
            "remark": null,
            "checkTime": null,
            "deviceMaxWatt": null,
            "baiduLat": null,
            "baiduLng": null,
            "tencentLat": null,
            "tencentLng": null,
            "estateAddressTypeId": null,
            "repairNum": null,
            "manufacturerName": null,
            "warrantyTime": null,
            "orderEndTime": null,
            "entryTime": null,
            "warrantyStatus": null,
            "warranty": null,
            "removeTime": null,
            "estateType": null,
            "peakPlainValley": null,
            "chargePriceType": null,
            "jumpMoudleFlag": null,
            "priceStandard": "",
            "payAccountId": null,
            "partner": null,
            "distance": 0.1,
            "isMerchantBears": 0,
            "isElectronicChargeCard": false,
            "minChargePrice": null,
            "priceStandardUnitType": null,
            "isOpen": null,
            "electronicChargeCardValue": null,
            "isSetPurchaseGift": null,
            "payChannel": null,
            "electronicChargeCard": false,
            "supportBlueTooth": null
        },
        {
            "id": 773289,
            "name": "ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ3å·æ¡©",
            "simId": "863060079153326",
            "simProvide": null,
            "ownerId": 1315,
            "portNumber": 20,
            "freePortCount": 3,
            "protocolType": null,
            "provinceId": 1,
            "provinceName": null,
            "cityId": 2,
            "cityName": null,
            "countyId": 1692,
            "countyName": null,
            "estateId": 177063,
            "estateName": null,
            "factory": null,
            "online": 1,
            "status": 1,
            "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæ—ºç§‘ä¸œè·¯",
            "chargePriceId": 143131,
            "chargePriceName": null,
            "payWay": null,
            "place": null,
            "inTime": 1734322376145,
            "updateTime": null,
            "lat": 40.044545,
            "lng": 116.282972,
            "hardwareId": null,
            "deviceType": 96,
            "deviceFamily": 0,
            "electricType": 0,
            "cooperationType": 99,
            "settlementType": null,
            "estateContact": null,
            "estateTel": null,
            "iccid": null,
            "moduleType": null,
            "occupancyFee": null,
            "priceStandardId": null,
            "mainVersion": null,
            "userDeviceType": null,
            "userDeviceTypeName": null,
            "maxWatt": null,
            "addEntranceType": null,
            "switchCabInfoDTO": null,
            "queryPriceStandardResult": null,
            "isMjDevice": null,
            "routeType": 4,
            "vdNo": null,
            "productSn": null,
            "investmentMoney": null,
            "isUnion": null,
            "totalAmount": null,
            "unionServiceFee": null,
            "serviceFeeStatus": null,
            "serviceFeeTime": null,
            "remark": null,
            "checkTime": null,
            "deviceMaxWatt": null,
            "baiduLat": null,
            "baiduLng": null,
            "tencentLat": null,
            "tencentLng": null,
            "estateAddressTypeId": null,
            "repairNum": null,
            "manufacturerName": null,
            "warrantyTime": null,
            "orderEndTime": null,
            "entryTime": null,
            "warrantyStatus": null,
            "warranty": null,
            "removeTime": null,
            "estateType": null,
            "peakPlainValley": null,
            "chargePriceType": null,
            "jumpMoudleFlag": null,
            "priceStandard": "",
            "payAccountId": null,
            "partner": null,
            "distance": 0.1,
            "isMerchantBears": 0,
            "isElectronicChargeCard": false,
            "minChargePrice": null,
            "priceStandardUnitType": null,
            "isOpen": null,
            "electronicChargeCardValue": null,
            "isSetPurchaseGift": null,
            "payChannel": null,
            "electronicChargeCard": false,
            "supportBlueTooth": null
        },
        {
            "id": 773285,
            "name": "ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ1å·æ¡©",
            "simId": "867997075125699",
            "simProvide": null,
            "ownerId": 1315,
            "portNumber": 20,
            "freePortCount": 3,
            "protocolType": null,
            "provinceId": 1,
            "provinceName": null,
            "cityId": 2,
            "cityName": null,
            "countyId": 1692,
            "countyName": null,
            "estateId": 177063,
            "estateName": null,
            "factory": null,
            "online": 1,
            "status": 1,
            "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæ—ºç§‘ä¸œè·¯",
            "chargePriceId": 143131,
            "chargePriceName": null,
            "payWay": null,
            "place": null,
            "inTime": 1734322216091,
            "updateTime": null,
            "lat": 40.044616,
            "lng": 116.282966,
            "hardwareId": null,
            "deviceType": 96,
            "deviceFamily": 0,
            "electricType": 0,
            "cooperationType": 99,
            "settlementType": null,
            "estateContact": null,
            "estateTel": null,
            "iccid": null,
            "moduleType": null,
            "occupancyFee": null,
            "priceStandardId": null,
            "mainVersion": null,
            "userDeviceType": null,
            "userDeviceTypeName": null,
            "maxWatt": null,
            "addEntranceType": null,
            "switchCabInfoDTO": null,
            "queryPriceStandardResult": null,
            "isMjDevice": null,
            "routeType": 4,
            "vdNo": null,
            "productSn": null,
            "investmentMoney": null,
            "isUnion": null,
            "totalAmount": null,
            "unionServiceFee": null,
            "serviceFeeStatus": null,
            "serviceFeeTime": null,
            "remark": null,
            "checkTime": null,
            "deviceMaxWatt": null,
            "baiduLat": null,
            "baiduLng": null,
            "tencentLat": null,
            "tencentLng": null,
            "estateAddressTypeId": null,
            "repairNum": null,
            "manufacturerName": null,
            "warrantyTime": null,
            "orderEndTime": null,
            "entryTime": null,
            "warrantyStatus": null,
            "warranty": null,
            "removeTime": null,
            "estateType": null,
            "peakPlainValley": null,
            "chargePriceType": null,
            "jumpMoudleFlag": null,
            "priceStandard": "",
            "payAccountId": null,
            "partner": null,
            "distance": 0.1,
            "isMerchantBears": 0,
            "isElectronicChargeCard": false,
            "minChargePrice": null,
            "priceStandardUnitType": null,
            "isOpen": null,
            "electronicChargeCardValue": null,
            "isSetPurchaseGift": null,
            "payChannel": null,
            "electronicChargeCard": false,
            "supportBlueTooth": null
        }
    ],
    "success": true,
    "message": "æŸ¥è¯¢æˆåŠŸ"
}
```

# è·å–æŸä¸ªå……ç”µæ¡©è¯¦æƒ…

è¯·æ±‚
```
curl 'https://appapi.lvcchong.com/portDetail?channelMessage=LVCC-WO-PH_2025.09.12_Tencent-H10'  -H 'Host: appapi.lvcchong.com'  -H 'Accept: */*'  -H 'Sec-Fetch-Site: same-site'  -H 'Accept-Language: zh-CN,zh-Hans;q=0.9'  -H 'Accept-Encoding: gzip, deflate'  -H 'Sec-Fetch-Mode: cors'  -H 'token: eyJhbGciOiJSUzI1NiIsImtpZCI6ImJmYmE3ZjNkZGQ3YTRlMmI4NjJjZDIyMGY3NWZhMWI5In0.eyJqdGkiOiI2d2NwVVhMcDVLVXdnYjV0c2lxQ1J3IiwiaWF0IjoxNzYwMTY1MzE1LCJleHAiOjE3NjAxNjUzNDUsIm5iZiI6MTc2MDE2NTI1NSwic3ViIjoiMSIsImF1ZCI6IklfRE9OT1RfQ0FSRSIsInVzZXJJZCI6Ijc3MDMzMTIxIn0.IXdmjYaP9Hr8XVUqQ0NTsr2qjcCo1z2rqxU28HLQvQ1pMeVC-1MiYoC2xvUdFQb9G-P-VHck1JVNEVNnWQxBTSy0R9vgJ5KbumM77n2Z6lG5DZ1wrnHVboEefIA1Vwe5RCd3ALGAr2hv13N85_Tz_MvwCgebWUcLEaa6PjfCVKlrheLlIn2DRczd728_WEgrNZm8ytQ19JkrxGjgvjEJn1tencHzObfDmMDuNcnH6OPwcFukoheRKDs_IFmj_AshQJu_eVmpyfGreA4YLo5J0gM6a4vFYw_QJOXt6Ta_tJY36ExT6gsZjJ29VHdwcCjEQZjteSk6Olui-4LNDYxheg'  -H 'Origin: https://h5.lvcchong.com'  -H 'Content-Length: 73'  -H 'User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 18_6 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 MicroMessenger/8.0.63(0x18003f2f) NetType/WIFI Language/zh_CN'  -H 'Referer: https://h5.lvcchong.com/'  -H 'Connection: keep-alive'  -H 'Content-Type: application/x-www-form-urlencoded'  -H 'Sec-Fetch-Dest: empty'   --data 'simId=867997075125699&mapType=2&chargeTypeTag=0&appEntrance=1&version=new' --compressed
```

å“åº”
```json
{"code":200,"data":{"isMerchantBears":0,"businessInvoiceFlag":true,"scramDeviceFlag":0,"accessJudgmentFlag":0,"ports":[0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,0,1,1,0],"chargingFlag":false,"errorMsg":"è®¾å¤‡ç»´æŠ¤ä¸­","accessWithApp":0,"machineFault":0,"userEstateCardBalance":null,"isOfficialAccountFlag":null,"updateLatLng":1,"isElectronicChargeCard":false,"isBgDevice":false,"device":{"id":773285,"name":"ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ1å·æ¡©","simId":"867997075125699","simProvide":0,"ownerId":1315,"portNumber":20,"freePortCount":3,"protocolType":null,"provinceId":1,"provinceName":"åŒ—äº¬å¸‚","cityId":2,"cityName":"åŒ—äº¬å¸‚","countyId":1692,"countyName":"æµ·æ·€åŒº","estateId":177063,"estateName":"ä¸­ç”µé‡‘ä¿¡å¤§å¦è‡ªè¡Œè½¦å……ç”µç«™","factory":3,"online":1,"status":1,"address":"åŒ—äº¬å¸‚æµ·æ·€åŒºæ—ºç§‘ä¸œè·¯","chargePriceId":143131,"chargePriceName":null,"payWay":3,"place":0,"inTime":1734322216000,"updateTime":1757950620000,"lat":40.044616,"lng":116.282966,"hardwareId":0,"deviceType":96,"deviceFamily":0,"electricType":0,"cooperationType":99,"settlementType":null,"estateContact":null,"estateTel":null,"iccid":"898608411124D2174500","moduleType":13,"occupancyFee":null,"priceStandardId":-1,"mainVersion":268,"userDeviceType":4,"userDeviceTypeName":"äºŒè½®è½¦-20è·¯è®¾å¤‡","maxWatt":0.0,"addEntranceType":null,"switchCabInfoDTO":null,"queryPriceStandardResult":null,"isMjDevice":null,"routeType":null,"vdNo":null,"productSn":null,"investmentMoney":null,"isUnion":0,"totalAmount":0.00,"unionServiceFee":0.00,"serviceFeeStatus":0,"serviceFeeTime":null,"remark":null,"checkTime":null,"deviceMaxWatt":null,"baiduLat":40.050955,"baiduLng":116.289329,"tencentLat":40.044616,"tencentLng":116.282966,"estateAddressTypeId":null,"repairNum":null,"manufacturerName":null,"warrantyTime":null,"orderEndTime":null,"entryTime":null,"warrantyStatus":null,"warranty":null,"removeTime":null,"estateType":null,"peakPlainValley":null,"chargePriceType":null}},"success":true,"message":"æˆåŠŸ"}
```

---

# Workers å®ç°çš„ API æ¥å£

ä»¥ä¸‹æ˜¯æˆ‘ä»¬åŸºäº Cloudflare Workers å®ç°çš„ API æ¥å£ï¼š

## 1. è·å–çŠ¶æ€å˜åŒ–äº‹ä»¶

**æ¥å£åœ°å€ï¼š** `GET /events?date=YYYY-MM-DD`

**åŠŸèƒ½ï¼š** æŸ¥è¯¢æŒ‡å®šæ—¥æœŸçš„å……ç”µæ¡©çŠ¶æ€å˜åŒ–äº‹ä»¶

**è¯·æ±‚å‚æ•°ï¼š**
- `date` (å¯é€‰): æ—¥æœŸå­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸º `YYYY-MM-DD`ï¼Œä¸ä¼ åˆ™é»˜è®¤å½“å¤©

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```bash
curl 'https://your-worker.workers.dev/events?date=2025-10-11'
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "date": "2025-10-11",
  "events": [
    {
      "id": "1-3-1728648600000",
      "stationId": 1,
      "stationName": "1å·å……ç”µæ¡©",
      "socketId": 3,
      "oldStatus": "available",
      "newStatus": "occupied",
      "timestamp": 1728648600000,
      "timeString": "2025-10-11 15:30:00"
    },
    {
      "id": "2-5-1728645000000",
      "stationId": 2,
      "stationName": "2å·å……ç”µæ¡©",
      "socketId": 5,
      "oldStatus": "occupied",
      "newStatus": "available",
      "timestamp": 1728645000000,
      "timeString": "2025-10-11 14:30:00"
    }
  ]
}
```

**çŠ¶æ€è¯´æ˜ï¼š**
- `available`: æ’åº§ç©ºé—²ï¼Œå¯ä½¿ç”¨
- `occupied`: æ’åº§å ç”¨ï¼Œæ­£åœ¨å……ç”µ

## 2. æ‰‹åŠ¨è§¦å‘çŠ¶æ€æ£€æŸ¥

**æ¥å£åœ°å€ï¼š** `POST /check-status`

**åŠŸèƒ½ï¼š** æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡å……ç”µæ¡©çŠ¶æ€æ£€æŸ¥ï¼ˆç”¨äºæµ‹è¯•å’Œè°ƒè¯•ï¼‰

**è¯·æ±‚ç¤ºä¾‹ï¼š**
```bash
curl -X POST 'https://your-worker.workers.dev/check-status'
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "çŠ¶æ€æ£€æŸ¥å®Œæˆ",
  "result": {
    "timestamp": 1728648600000,
    "timeString": "2025-10-11 15:30:00",
    "stationsCount": 3,
    "eventsCount": 2,
    "hasAnyChange": true,
    "stations": [
      {
        "id": 1,
        "name": "1å·å……ç”µæ¡©",
        "simId": "867997075125699",
        "sockets": [
          { "id": 1, "status": "available" },
          { "id": 2, "status": "occupied" },
          { "id": 3, "status": "available" }
        ],
        "online": true,
        "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæ—ºç§‘ä¸œè·¯",
        "timestamp": 1728648600000
      }
    ],
    "events": [
      {
        "id": "1-2-1728648600000",
        "stationId": 1,
        "stationName": "1å·å……ç”µæ¡©",
        "socketId": 2,
        "oldStatus": "available",
        "newStatus": "occupied",
        "timestamp": 1728648600000,
        "timeString": "2025-10-11 15:30:00"
      }
    ]
  }
}
```

## çŠ¶æ€ç›‘æ§è¯´æ˜

### ç›‘æ§é…ç½®
- **ç›‘æ§é¢‘ç‡**: æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼ˆé€šè¿‡ Cron è§¦å‘å™¨ `* * * * *`ï¼‰
- **ç›‘æ§æ—¶é—´**: å…¨å¤©24å°æ—¶ä¸é—´æ–­ç›‘æ§
- **ç›‘æ§èŒƒå›´**: 3ä¸ªå……ç”µæ¡©ï¼ˆä¸­ç”µé‡‘ä¿¡1ã€2ã€3å·æ¡©ï¼‰

### KV å­˜å‚¨ä¼˜åŒ–

ä¸ºé€‚åº” Cloudflare Workers KV å…è´¹å¥—é¤é™åˆ¶ï¼ˆæ¯å¤© 1000 æ¬¡å†™å…¥ï¼‰ï¼Œé‡‡ç”¨æ™ºèƒ½å†™å…¥ç­–ç•¥ï¼š

#### v2.0 ä¼˜åŒ–ç­–ç•¥ (2025-11-03)

1. **çŠ¶æ€å˜åŒ–æ£€æµ‹**
   - æ¯æ¬¡æ£€æŸ¥æ—¶è¯»å–ä¸Šä¸€æ¬¡çš„çŠ¶æ€
   - å¯¹æ¯”å½“å‰çŠ¶æ€ä¸å†å²çŠ¶æ€
   - ä»…åœ¨æ£€æµ‹åˆ°å˜åŒ–æ—¶å†™å…¥ KV

2. **ç²¾ç®€å­˜å‚¨**
   - **æœ€æ–°çŠ¶æ€** (`latest:{stationId}`): åªåœ¨è¯¥å……ç”µæ¡©çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°
   - **å˜åŒ–äº‹ä»¶** (`events:{date}`): åªåœ¨æœ‰çŠ¶æ€å˜åŒ–æ—¶è¿½åŠ äº‹ä»¶
   - ~~**çŠ¶æ€å¿«ç…§**~~: å·²ç§»é™¤ï¼ˆå¯ä»äº‹ä»¶åˆ—è¡¨é‡å»ºå†å²çŠ¶æ€ï¼‰

3. **é…é¢ç›‘æ§**
   - **é…é¢è®¡æ•°** (`quota:writes:{date}`): è¿½è¸ªæ¯æ—¥ç´¯è®¡å†™å…¥æ¬¡æ•°
   - è¾¾åˆ° 80% é…é¢æ—¶å‘å‡º âš ï¸ è­¦å‘Š
   - è¾¾åˆ° 95% é…é¢æ—¶å‘å‡º ğŸš¨ ä¸¥é‡é¢„è­¦

4. **å†™å…¥æ¬¡æ•°ä¼°ç®—**
   - å‡è®¾æ¯å¤©æœ‰ N æ¬¡çŠ¶æ€å˜åŒ–
   - æœ€æ–°çŠ¶æ€å†™å…¥ï¼šæœ€å¤š N æ¬¡
   - äº‹ä»¶è®°å½•å†™å…¥ï¼šæœ€å¤š N æ¬¡
   - é…é¢è®¡æ•°å†™å…¥ï¼šæœ€å¤š N æ¬¡
   - **æ€»è®¡**: æœ€å¤š 3N æ¬¡å†™å…¥

5. **ä¼˜åŒ–æ•ˆæœ**
   - v1.0 ç­–ç•¥ï¼šçº¦ 1,010 æ¬¡/å¤©ï¼ˆè¶…é™ âš ï¸ï¼‰
   - v2.0 ç­–ç•¥ï¼šçº¦ 675 æ¬¡/å¤©ï¼ˆèŠ‚çœ 33% âœ…ï¼‰
   - åœ¨æ­£å¸¸ä½¿ç”¨æƒ…å†µä¸‹ï¼ˆæ¯å¤©çŠ¶æ€å˜åŒ–ä¸è¶…è¿‡ 330 æ¬¡ï¼‰ä¸ä¼šè¶…è¿‡å…è´¹å¥—é¤é™åˆ¶

### æ•°æ®ä¿ç•™ç­–ç•¥
- **æœ€æ–°çŠ¶æ€**: æ— é™æœŸä¿å­˜
- **å˜åŒ–äº‹ä»¶**: ä¿ç•™ 7 å¤©ï¼Œæ¯å¤©æœ€å¤šä¿å­˜ 1000 ä¸ªäº‹ä»¶
- **é…é¢è®¡æ•°**: ä¿ç•™ 7 å¤©

---

# Worker API æ¥å£

ä»¥ä¸‹æ˜¯å……ç”µæ¡©ç›‘æ§ç³»ç»Ÿæä¾›çš„å†…éƒ¨ API æ¥å£ã€‚

## åŸºç¡€ä¿¡æ¯

**Base URL**: `https://electric-bike-charging-pile.hansnow.me`

**è®¤è¯æ–¹å¼**: éƒ¨åˆ†æ¥å£éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æä¾› `X-Admin-Token`

## çŠ¶æ€ç›‘æ§æ¥å£

### 1. æŸ¥è¯¢é™„è¿‘å……ç”µæ¡©

```http
POST /nearby
Content-Type: application/json

{
  "positioningFlag": 1,
  "deviceFamily": 0,
  "lat": 40.043910,
  "lng": 116.283760,
  "name": "",
  "mapType": 2
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": [
    {
      "id": 773288,
      "name": "ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ2å·æ¡©",
      "simId": "863060079195715",
      "portNumber": 20,
      "freePortCount": 8,
      "online": 1,
      "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæ—ºç§‘ä¸œè·¯",
      // ... æ›´å¤šå­—æ®µ
    }
  ]
}
```

### 2. æŸ¥è¯¢å……ç”µæ¡©è¯¦æƒ…

```http
POST /detail
Content-Type: application/json

{
  "simId": "867997075125699",
  "mapType": 2,
  "chargeTypeTag": 0,
  "appEntrance": 1,
  "version": "new"
}
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "ports": [
      { "status": 0, "statusSince": null },
      { "status": 1, "statusSince": 1762938823000 }
    ],
    "device": {
      "id": 773287,
      "name": "ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ1å·æ¡©",
      "simId": "867997075125699",
      "portNumber": 20,
      "freePortCount": 10,
      "online": 1,
      // ... æ›´å¤šå­—æ®µ
    }
  }
}
```

### 3. æŸ¥è¯¢çŠ¶æ€å˜åŒ–äº‹ä»¶

```http
GET /events?date=2025-11-12
```

**å‚æ•°**:
- `date` (å¯é€‰): æ—¥æœŸï¼Œæ ¼å¼ YYYY-MM-DDï¼Œé»˜è®¤ä»Šå¤©

**å“åº”**:
```json
{
  "success": true,
  "date": "2025-11-12",
  "events": [
    {
      "id": "1-2-1762938823000",
      "stationId": 1,
      "stationName": "1å·å……ç”µæ¡©",
      "socketId": 2,
      "oldStatus": "occupied",
      "newStatus": "available",
      "timestamp": 1762938823000,
      "timeString": "2025-11-12 16:13:43"
    }
  ]
}
```

### 4. æ‰‹åŠ¨è§¦å‘çŠ¶æ€æ£€æŸ¥

```http
POST /check-status
```

**å“åº”**:
```json
{
  "success": true,
  "message": "çŠ¶æ€æ£€æŸ¥å®Œæˆ",
  "result": {
    "timestamp": 1762938823000,
    "timeString": "2025-11-12 16:13:43",
    "stationsCount": 3,
    "eventsCount": 15,
    "hasAnyChange": true
  }
}
```

### 5. æŸ¥è¯¢ç»Ÿè®¡æ•°æ®

```http
GET /statistics?start=2025-11-01&end=2025-11-12
```

**å‚æ•°**:
- `start` (å¯é€‰): å¼€å§‹æ—¥æœŸï¼Œé»˜è®¤ä»Šå¤©
- `end` (å¯é€‰): ç»“æŸæ—¥æœŸï¼Œé»˜è®¤ä»Šå¤©
- æ—¥æœŸèŒƒå›´ä¸èƒ½è¶…è¿‡ 31 å¤©

**å“åº”**:
```json
{
  "success": true,
  "startDate": "2025-11-01",
  "endDate": "2025-11-12",
  "statistics": {
    "daily": [...],
    "hourly": [...]
  }
}
```

---

## ç©ºé—²æé†’æ¥å£

### 1. æŸ¥è¯¢ç©ºé—²æé†’é…ç½®

```http
GET /api/alert/config
```

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "id": 1,
    "idle_threshold_minutes": 30,
    "time_range_start": "08:00",
    "time_range_end": "17:00",
    "webhook_urls": "[\"https://webhook.site/xxx\"]",
    "enabled_station_ids": null,
    "enabled": 1,
    "retry_times": 2,
    "retry_interval_seconds": 60,
    "lark_enabled": 0,
    "lark_auth_token": null,
    "lark_chat_id": null,
    "created_at": 1762938823,
    "updated_at": 1762938823
  }
}
```

### 2. æ›´æ–°ç©ºé—²æé†’é…ç½®

```http
POST /api/alert/config
X-Admin-Token: your-admin-token
Content-Type: application/json

{
  "idle_threshold_minutes": 45,
  "time_range_start": "09:00",
  "time_range_end": "18:00",
  "webhook_urls": "[\"https://webhook.site/xxx\"]",
  "enabled": 1,
  "lark_enabled": 1,
  "lark_auth_token": "your-lark-auth-token",
  "lark_chat_id": "oc_xxx"
}
```

**å‚æ•°æ ¡éªŒ**:
- `idle_threshold_minutes`: 1-1440 ä¹‹é—´
- `time_range_start/end`: HH:mm æ ¼å¼
- `webhook_urls`: JSON æ•°ç»„ï¼Œæ¯ä¸ª URL å¿…é¡»ä»¥ http/https å¼€å¤´
- `enabled`: 0 æˆ– 1
- `retry_times`: 0-10 ä¹‹é—´
- `retry_interval_seconds`: 1-300 ä¹‹é—´
- `enabled_station_ids`: JSON æ•°ç»„æˆ– null
- `lark_enabled`: 0ï¼ˆç¦ç”¨ï¼‰æˆ– 1ï¼ˆå¯ç”¨ï¼‰
- `lark_auth_token`: é£ä¹¦é‰´æƒä»¤ç‰Œï¼ˆå­—ç¬¦ä¸²ï¼‰
- `lark_chat_id`: é£ä¹¦ç¾¤ç»„ IDï¼ˆå¯é€‰ï¼Œå¦‚æœé…ç½®äº†é»˜è®¤ç¾¤ç»„å¯ä¸ä¼ ï¼‰

**å“åº”**:
```json
{
  "success": true,
  "message": "é…ç½®æ›´æ–°æˆåŠŸ"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "error": "ç¼ºå°‘ X-Admin-Token è¯·æ±‚å¤´"
}
```

### 3. æŸ¥è¯¢ç©ºé—²æé†’æ—¥å¿—

```http
GET /api/alert/logs?date=2025-11-12&limit=100&offset=0
```

**æŸ¥è¯¢å‚æ•°**:
- `date` (å¯é€‰): æ—¥æœŸè¿‡æ»¤ï¼ˆYYYY-MM-DDï¼‰
- `stationId` (å¯é€‰): å……ç”µæ¡©ID
- `socketId` (å¯é€‰): æ’åº§ID
- `success` (å¯é€‰): æˆåŠŸçŠ¶æ€ï¼ˆ'true'/'false'ï¼‰
- `limit` (å¯é€‰): è¿”å›æ•°é‡ï¼Œé»˜è®¤ 100
- `offset` (å¯é€‰): åç§»é‡ï¼Œé»˜è®¤ 0

**å“åº”**:
```json
{
  "success": true,
  "data": [
    {
      "id": "1-2-https://webhook.site/xxx-1762938823",
      "station_id": 1,
      "station_name": "1å·å……ç”µæ¡©",
      "socket_id": 2,
      "idle_minutes": 60,
      "idle_start_time": 1762935223,
      "webhook_url": "https://webhook.site/xxx",
      "response_status": 200,
      "response_body": "OK",
      "response_time_ms": 234,
      "success": 1,
      "error_message": null,
      "retry_count": 0,
      "triggered_at": 1762938823,
      "sent_at": 1762938823,
      "log_date": "2025-11-12",
      "lark_message_id": "om_xxx",
      "lark_success": 1,
      "lark_error_message": null,
      "lark_response_time_ms": 156
    }
  ],
  "count": 1
}
```

### 4. æµ‹è¯• Webhook

```http
POST /api/alert/test
X-Admin-Token: your-admin-token
```

å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°æ‰€æœ‰é…ç½®çš„ Webhook URLã€‚

**å“åº”**:
```json
{
  "success": true,
  "message": "æµ‹è¯•å®Œæˆ",
  "results": [
    {
      "url": "https://webhook.site/xxx",
      "success": true,
      "status": 200,
      "body": "OK",
      "retryCount": 0,
      "elapsedMs": 234
    }
  ]
}
```

### 5. æŸ¥è¯¢ç©ºé—²æé†’ç»Ÿè®¡

```http
GET /api/alert/stats
```

è¿”å›è¿‘ 7 å¤©çš„ç»Ÿè®¡æ•°æ®ã€‚

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "summary": {
      "total": 150,
      "successCount": 145,
      "failedCount": 5,
      "successRate": 97,
      "avgResponseTime": 235.5
    },
    "byStation": [
      {
        "station_id": 1,
        "station_name": "1å·å……ç”µæ¡©",
        "total": 50,
        "success_count": 48
      }
    ],
    "trend": [
      {
        "log_date": "2025-11-12",
        "total": 25,
        "success_count": 24
      }
    ]
  }
}
```

### Webhook Payload æ ¼å¼

å½“æ£€æµ‹åˆ°æ’åº§ç©ºé—²è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿä¼šå‘é…ç½®çš„ Webhook URL å‘é€ POST è¯·æ±‚ï¼š

```json
{
  "alertType": "socket_idle",
  "timestamp": 1762938823,
  "timeString": "2025-11-12 16:13:43",
  "station": {
    "id": 1,
    "name": "1å·å……ç”µæ¡©"
  },
  "socket": {
    "id": 2,
    "status": "available",
    "idleMinutes": 60,
    "idleStartTime": 1762935223,
    "idleStartTimeString": "2025-11-12 15:13:43"
  },
  "config": {
    "threshold": 30,
    "timeRange": "08:00-17:00"
  }
}
```

---

## é”™è¯¯å“åº”æ ¼å¼

æ‰€æœ‰æ¥å£åœ¨å‘ç”Ÿé”™è¯¯æ—¶è¿”å›ç»Ÿä¸€æ ¼å¼ï¼š

```json
{
  "success": false,
  "error": "é”™è¯¯æè¿°ä¿¡æ¯"
}
```

HTTP çŠ¶æ€ç ï¼š
- `200` - æˆåŠŸ
- `400` - è¯·æ±‚å‚æ•°é”™è¯¯
- `401` - ç¼ºå°‘è®¤è¯ Token
- `403` - Token æ— æ•ˆ
- `500` - æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

## é£ä¹¦æ¶ˆæ¯å‘é€

ç©ºé—²æé†’åŠŸèƒ½æ”¯æŒé€šè¿‡é£ä¹¦æ¶ˆæ¯é€šçŸ¥ã€‚å½“æ£€æµ‹åˆ°ç©ºé—²æ’åº§æ—¶ï¼Œç³»ç»Ÿä¼šåŒæ—¶ï¼š
1. å‘é€ Webhook è¯·æ±‚åˆ°é…ç½®çš„ URL
2. å‘é€é£ä¹¦æ¶ˆæ¯åˆ°é…ç½®çš„ç¾¤ç»„ï¼ˆå¦‚æœå¯ç”¨ï¼‰

### æ¶ˆæ¯æ ¼å¼

é£ä¹¦æ¶ˆæ¯ä½¿ç”¨å›ºå®šæ¨¡æ¿ï¼š`xå·å……ç”µæ¡©yå·æ’åº§å·²ç»ç©ºé—²zåˆ†é’Ÿå•¦`

ä¾‹å¦‚ï¼š`1å·å……ç”µæ¡©2å·æ’åº§å·²ç»ç©ºé—²30åˆ†é’Ÿå•¦`

### é…ç½®æ–¹å¼

é€šè¿‡æ›´æ–°é…ç½®æ¥å£å¯ç”¨é£ä¹¦æé†’ï¼š

```json
{
  "lark_enabled": 1,
  "lark_auth_token": "your-lark-auth-token",
  "lark_chat_id": "oc_xxx"
}
```

- `lark_enabled`: è®¾ç½®ä¸º 1 å¯ç”¨ï¼Œ0 ç¦ç”¨
- `lark_auth_token`: é£ä¹¦æ¶ˆæ¯æœåŠ¡çš„é‰´æƒä»¤ç‰Œï¼ˆå¿…å¡«ï¼‰
- `lark_chat_id`: é£ä¹¦ç¾¤ç»„ IDï¼ˆå¯é€‰ï¼Œå¦‚æœæœåŠ¡ç«¯é…ç½®äº†é»˜è®¤ç¾¤ç»„ï¼‰

### æ—¥å¿—è®°å½•

é£ä¹¦æ¶ˆæ¯å‘é€ç»“æœä¼šè®°å½•åœ¨æ—¥å¿—ä¸­ï¼š
- `lark_message_id`: é£ä¹¦æ¶ˆæ¯ ID
- `lark_success`: å‘é€æ˜¯å¦æˆåŠŸï¼ˆ1=æˆåŠŸï¼Œ0=å¤±è´¥ï¼‰
- `lark_error_message`: é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
- `lark_response_time_ms`: å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

---

## ç›¸å…³æ–‡æ¡£

- [ç©ºé—²æé†’åŠŸèƒ½å®ç°æ–‡æ¡£](./docs/idle-alert-implementation.md)
- [ç©ºé—²æé†’åŠŸèƒ½è®¾è®¡æ–‡æ¡£](./docs/idle-alert-design.md)
- [é£ä¹¦æ¶ˆæ¯é›†æˆæ–‡æ¡£](./docs/lark-integration.md)