# 时区修复说明

## 问题描述

用户反馈在前端界面查看状态变化事件时，所有事件都从北京时间 08:00 开始显示，缺少 00:00-08:00 之间的数据。

## 根本原因

系统中存在两个时区相关的问题：

### 1. 事件查询时间范围错误

**文件**: `d1-storage.ts`

**问题代码**:
```typescript
const startTimestamp = new Date(`${date}T00:00:00Z`).getTime();
```

**问题分析**:
- `${date}T00:00:00Z` 中的 `Z` 表示 UTC 时区
- 用户选择日期 "2025-11-13" 时，实际查询的是 UTC 2025-11-13 00:00:00 开始的数据
- UTC 00:00 对应北京时间 **08:00**（UTC+8）
- 因此查询结果从北京时间 08:00 开始

**修复方案**:
```typescript
// 北京时间（UTC+8）转换为 UTC 时间戳
const bjOffset = 8 * 60 * 60 * 1000; // 8小时
const startTimestamp = new Date(`${date}T00:00:00Z`).getTime() - bjOffset;
```

这样查询 "2025-11-13" 时，实际查询的是：
- UTC 时间: 2025-11-12 16:00:00 到 2025-11-13 16:00:00
- 对应北京时间: 2025-11-13 00:00:00 到 2025-11-14 00:00:00

**影响的函数**:
1. `getEventsD1()` - 查询指定日期的事件
2. `getEventsInRangeD1()` - 查询时间范围内的事件
3. `getStatisticsD1()` - 统计功能

### 2. 事件存储的时间字符串使用 UTC 时间

**文件**: `status-tracker.ts`

**问题代码**:
```typescript
export function getTimeString(date: Date = new Date()): string {
  return date.toISOString().replace('T', ' ').substring(0, 19);
}
```

**问题分析**:
- `toISOString()` 返回 UTC 时间字符串
- 数据库中 `time_string` 字段存储的是 UTC 时间（如 "2025-11-12 16:16:55"）
- 但用户期望看到北京时间（如 "2025-11-13 00:16:55"）

**修复方案**:
```typescript
export function getTimeString(date: Date = new Date()): string {
  // 转换为北京时间字符串 (UTC+8)
  const bjDate = new Date(date.getTime() + 8 * 60 * 60 * 1000);
  return bjDate.toISOString().replace('T', ' ').substring(0, 19);
}
```

**同时修复的函数**:
- `getDateString()` - 获取日期字符串，也改为返回北京时间日期

### 3. 前端时间显示逻辑简化

**文件**: `public/index.html`

**原代码**:
```javascript
// 将UTC时间字符串转换为北京时间显示
function formatBeijingTime(utcTimeString) {
  const isoString = utcTimeString.replace(' ', 'T') + 'Z';
  const date = new Date(isoString);
  return date.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', ... });
}
```

**修复后**:
```javascript
// 格式化北京时间字符串显示
function formatBeijingTime(beijingTimeString) {
  // beijingTimeString 已经是北京时间，直接格式化即可
  const date = new Date(beijingTimeString.replace(' ', 'T'));
  return date.toLocaleString('zh-CN', { ... });
}
```

## 修复影响

### 立即生效
- ✅ 事件查询范围修正，可以查询到完整的 00:00-24:00 数据
- ✅ 新产生的事件将使用北京时间字符串存储
- ✅ 前端显示逻辑简化

### 历史数据
- ⚠️ 数据库中已有的旧数据仍使用 UTC 时间字符串
- ⚠️ 旧数据在前端显示时可能不正确（会少 8 小时）
- 💡 建议：可以编写迁移脚本批量更新历史数据的 `time_string` 字段

## 验证方法

### 1. 查询 API 验证
```bash
curl "https://electric-bike-charging-pile.hansnow.me/events?date=2025-11-13" | jq '.events[:5]'
```

应该能看到 00:00-08:00 之间的事件。

### 2. 前端界面验证
访问 https://electric-bike-charging-pile.hansnow.me/，选择今天的日期，应该能看到完整的 24 小时事件记录。

## 最佳实践总结

1. **时间戳存储**: 使用 UTC 时间戳（毫秒数），便于跨时区计算
2. **时间字符串存储**: 使用应用所在时区的时间字符串（如北京时间），便于人工查看
3. **时间查询**: 查询时注意时区转换，确保查询范围正确
4. **前端显示**: 根据存储格式选择是否需要时区转换

## 部署记录

- **修复时间**: 2025-11-13
- **部署版本**: 04007d62-7c78-46cf-aa0a-b1c64611d9cf
- **影响范围**: 事件查询、事件存储、前端显示
