# 日志系统说明

## 概述

项目实现了完善的日志记录系统，确保每次状态检查都留下清晰的执行痕迹和必要信息。

## 日志特性

### ✨ 1. 视觉友好
- 使用 emoji 图标快速识别日志类型
- 使用分隔线清晰标记每次执行的开始和结束
- 缩进层级清晰，便于阅读

### 📊 2. 信息完整
- **时间信息**: UTC 时间和北京时间
- **充电桩状态**: 在线状态、插座数量、空闲/占用统计
- **状态变化**: 详细记录每个插座的状态变化
- **KV 操作**: 统计读取和写入次数
- **性能指标**: 记录每次执行的耗时

### 🔍 3. 便于调试
- 每次执行都有唯一的开始和结束标记
- 错误信息包含详细的堆栈跟踪
- 分层日志输出，便于定位问题

## 日志输出示例

### 成功执行（有状态变化）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 [定时任务] 开始执行状态检查
⏰ UTC时间: 2025-10-11T15:30:00.000Z
🕐 北京时间: 2025-10-11 23:30:00
📍 开始检查状态: 2025-10-11 15:30:00
  🔍 检查 [1号充电桩] (simId: 867997075125699)
     📊 在线: 是 | 插座: 20个 (空闲8/占用12)
     🔔 检测到 2 个状态变化:
        🔌 插座#3: available → occupied
        🔓 插座#5: occupied → available
     💾 已更新最新状态到 KV
  🔍 检查 [2号充电桩] (simId: 863060079195715)
     📊 在线: 是 | 插座: 20个 (空闲10/占用10)
     ✓ 无状态变化
  🔍 检查 [3号充电桩] (simId: 863060079153326)
     📊 在线: 是 | 插座: 20个 (空闲5/占用15)
     ✓ 无状态变化
💾 已存储状态快照 (包含 2 个变化事件)
💾 已存储 2 个状态变化事件
📈 本次检查统计:
   - KV 读取次数: 3
   - KV 写入次数: 3
   - 充电桩数量: 3
   - 状态变化数: 2
✅ [定时任务] 执行成功
📊 检查结果: {
  检查耗时: '1234ms',
  充电桩数量: 3,
  状态变化数: 2,
  是否有变化: '是',
  KV写入: '已写入'
}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 成功执行（无状态变化）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 [定时任务] 开始执行状态检查
⏰ UTC时间: 2025-10-11T15:31:00.000Z
🕐 北京时间: 2025-10-11 23:31:00
📍 开始检查状态: 2025-10-11 15:31:00
  🔍 检查 [1号充电桩] (simId: 867997075125699)
     📊 在线: 是 | 插座: 20个 (空闲8/占用12)
     ✓ 无状态变化
  🔍 检查 [2号充电桩] (simId: 863060079195715)
     📊 在线: 是 | 插座: 20个 (空闲10/占用10)
     ✓ 无状态变化
  🔍 检查 [3号充电桩] (simId: 863060079153326)
     📊 在线: 是 | 插座: 20个 (空闲5/占用15)
     ✓ 无状态变化
⏭️  无状态变化，跳过快照存储
📈 本次检查统计:
   - KV 读取次数: 3
   - KV 写入次数: 0
   - 充电桩数量: 3
   - 状态变化数: 0
✅ [定时任务] 执行成功
📊 检查结果: {
  检查耗时: '856ms',
  充电桩数量: 3,
  状态变化数: 0,
  是否有变化: '否',
  KV写入: '跳过写入'
}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 执行失败

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 [定时任务] 开始执行状态检查
⏰ UTC时间: 2025-10-11T15:32:00.000Z
🕐 北京时间: 2025-10-11 23:32:00
📍 开始检查状态: 2025-10-11 15:32:00
  🔍 检查 [1号充电桩] (simId: 867997075125699)
     ❌ 处理出错: Network timeout
❌ [定时任务] 执行失败
⏱️  耗时: 5000ms
💥 错误: Network timeout
📋 错误堆栈: Error: Network timeout
    at getDeviceDetail (/worker.ts:123:15)
    at performStatusCheck (/worker.ts:417:28)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## Emoji 图标说明

| Emoji | 含义 | 使用场景 |
|-------|------|----------|
| 🔄 | 执行开始 | 定时任务开始执行 |
| ⏰ | UTC 时间 | 显示任务调度的 UTC 时间 |
| 🕐 | 北京时间 | 显示转换后的北京时间 |
| 📍 | 检查开始 | 状态检查函数开始执行 |
| 🔍 | 检查中 | 正在检查某个充电桩 |
| 📊 | 状态信息 | 显示充电桩的基本状态 |
| ✓ | 无变化 | 该充电桩状态无变化 |
| 🔔 | 有变化 | 检测到状态变化 |
| 🔌 | 插座占用 | 插座状态变为占用 |
| 🔓 | 插座空闲 | 插座状态变为空闲 |
| 🆕 | 首次获取 | 首次获取充电桩状态 |
| 💾 | KV 写入 | 数据已写入 KV 存储 |
| ⏭️ | 跳过操作 | 跳过某个操作（如无变化时跳过写入）|
| 📈 | 统计信息 | 显示统计数据 |
| ✅ | 执行成功 | 任务执行成功 |
| ❌ | 执行失败 | 任务执行失败 |
| ⚠️ | 警告 | 警告信息 |
| 💥 | 错误 | 错误详情 |
| 📋 | 错误堆栈 | 错误堆栈信息 |
| ⏱️ | 耗时 | 执行耗时 |

## 查看实时日志

### 基本命令

```bash
# 查看实时日志（基本格式）
npx wrangler tail

# 查看实时日志（美化格式，推荐）
npx wrangler tail --format pretty

# 查看实时日志（JSON 格式，便于程序处理）
npx wrangler tail --format json
```

### 过滤和搜索

```bash
# 只查看有状态变化的日志
npx wrangler tail --format pretty | grep "状态变化"

# 只查看错误日志
npx wrangler tail --format pretty | grep "❌"

# 只查看某个充电桩的日志
npx wrangler tail --format pretty | grep "1号充电桩"

# 查看 KV 写入操作
npx wrangler tail --format pretty | grep "💾"
```

### 高级用法

```bash
# 保存日志到文件
npx wrangler tail --format pretty > logs.txt

# 实时查看并保存
npx wrangler tail --format pretty | tee logs.txt

# 只查看一次日志后退出（用于 CI/CD）
npx wrangler tail --format json --once > event.json
```

## 日志分析

### KV 写入次数统计

通过日志可以清晰地看到每次执行的 KV 写入次数：

- **无状态变化**: KV 写入次数 = 0
- **有状态变化**: KV 写入次数 = 1 + 1 + 1 = 3
  - 1 次最新状态写入（每个变化的充电桩）
  - 1 次状态快照写入
  - 1 次事件记录写入

### 性能监控

每次执行都会记录耗时，便于监控性能：

```
检查耗时: '1234ms'
```

如果耗时过长，可以通过日志定位是哪个充电桩查询慢。

### 状态变化追踪

日志会详细记录每个插座的状态变化：

```
🔔 检测到 2 个状态变化:
   🔌 插座#3: available → occupied
   🔓 插座#5: occupied → available
```

这样可以清楚地知道哪些插座在什么时间发生了什么变化。

## 最佳实践

### 1. 日常监控

```bash
# 在一个终端窗口中持续监控日志
npx wrangler tail --format pretty
```

### 2. 问题排查

```bash
# 查看错误日志
npx wrangler tail --format pretty | grep -E "(❌|⚠️|💥)"

# 查看最近的执行情况
npx wrangler tail --format json | jq '.event'
```

### 3. 性能分析

```bash
# 提取执行耗时
npx wrangler tail --format pretty | grep "检查耗时"
```

### 4. KV 使用分析

```bash
# 统计 KV 写入情况
npx wrangler tail --format pretty | grep "KV 写入次数"
```

## 注意事项

1. **日志保留时间**: Cloudflare Workers 的日志默认保留时间有限，建议重要日志定期保存到文件
2. **日志级别**: 当前所有日志都输出，如需调整可以修改代码中的 `console.log` 调用
3. **性能影响**: 日志输出对性能影响很小，但在高频场景下仍需注意
4. **敏感信息**: 确保日志中不包含敏感信息（如 token、密钥等）

## 相关文档

- [Cloudflare Workers 日志文档](https://developers.cloudflare.com/workers/observability/logs/)
- [Wrangler CLI 文档](https://developers.cloudflare.com/workers/wrangler/commands/)
- [实时日志文档](https://developers.cloudflare.com/workers/observability/logs/real-time-logs/)

