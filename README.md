# é«˜é€”ç”µåŠ¨è½¦å……ç”µæ¡© API æœåŠ¡

åŸºäº Cloudflare Workers æ„å»ºçš„ç”µåŠ¨è½¦å……ç”µæ¡©æŸ¥è¯¢æœåŠ¡ï¼Œæä¾›å……ç”µæ¡©åˆ—è¡¨æŸ¥è¯¢ã€è¯¦æƒ…æŸ¥è¯¢ç­‰åŠŸèƒ½ã€‚

## é¡¹ç›®ç‰¹æ€§

- ğŸš€ åŸºäº Cloudflare Workers éƒ¨ç½²ï¼Œå…¨çƒè¾¹ç¼˜è®¡ç®—
- ğŸ”§ å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- ğŸ“¡ RESTful API æ¥å£
- ğŸ§ª å†…ç½®æµ‹è¯•æµç¨‹
- ğŸ“Š å……ç”µæ¡©çŠ¶æ€ç»Ÿè®¡
- ğŸŒ CORS æ”¯æŒ

## é¡¹ç›®ç»“æ„

```
gaotu-electric-bike-charging-pile/
â”œâ”€â”€ types.ts              # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ util.ts               # API å·¥å…·å‡½æ•°
â”œâ”€â”€ worker.ts             # Cloudflare Worker ä¸»å…¥å£
â”œâ”€â”€ test-local.ts         # æœ¬åœ°æµ‹è¯•è„šæœ¬
â”œâ”€â”€ wrangler.toml         # Cloudflare Workers é…ç½®
â”œâ”€â”€ tsconfig.json         # TypeScript é…ç½®
â”œâ”€â”€ package.json          # é¡¹ç›®é…ç½®
â”œâ”€â”€ API.md               # API æ–‡æ¡£
â””â”€â”€ README.md            # é¡¹ç›®æ–‡æ¡£
```

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pnpm install
```

### æœ¬åœ°å¼€å‘

```bash
# å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨
pnpm run dev

# è¿è¡Œæœ¬åœ°æµ‹è¯•
npx tsx test-local.ts
```

### éƒ¨ç½²åˆ° Cloudflare Workers

```bash
# ç™»å½• Cloudflare
npx wrangler login

# éƒ¨ç½²
pnpm run deploy
```

## API æ¥å£

### 1. è·å–é™„è¿‘å……ç”µæ¡©åˆ—è¡¨

**æ¥å£åœ°å€ï¼š** `POST /nearby`

**è¯·æ±‚å‚æ•°ï¼š**
```typescript
{
  positioningFlag: number,  // å®šä½æ ‡å¿—
  deviceFamily: number,     // è®¾å¤‡ç±»å‹
  lat: number,             // çº¬åº¦
  lng: number,             // ç»åº¦
  name: string,            // æœç´¢åç§°
  mapType: number          // åœ°å›¾ç±»å‹
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": [
    {
      "id": 773288,
      "name": "ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ2å·æ¡©",
      "simId": "863060079195715",
      "portNumber": 20,
      "freePortCount": 8,
      "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæ—ºç§‘ä¸œè·¯",
      "lat": 40.044545,
      "lng": 116.282972
    }
  ]
}
```

### 2. è·å–å……ç”µæ¡©è¯¦æƒ…

**æ¥å£åœ°å€ï¼š** `POST /detail`

**è¯·æ±‚å‚æ•°ï¼š**
```typescript
{
  simId: string,           // è®¾å¤‡ SIM å¡å·
  mapType: number,         // åœ°å›¾ç±»å‹
  chargeTypeTag: number,   // å……ç”µç±»å‹æ ‡ç­¾
  appEntrance: number,     // åº”ç”¨å…¥å£
  version: string          // ç‰ˆæœ¬
}
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "ports": [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0],
    "chargingFlag": false,
    "errorMsg": "è®¾å¤‡ç»´æŠ¤ä¸­",
    "device": {
      "id": 773285,
      "name": "ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ1å·æ¡©"
    }
  }
}
```

### 3. æµ‹è¯•æµç¨‹

**æ¥å£åœ°å€ï¼š** `GET /test`

**åŠŸèƒ½ï¼š**
- è·å–é™„è¿‘å……ç”µæ¡©åˆ—è¡¨
- ç­›é€‰åç§°åŒ…å«"ä¸­ç”µé‡‘ä¿¡"çš„å……ç”µæ¡©
- ä¾æ¬¡è·å–è¿™äº›å……ç”µæ¡©çš„è¯¦æƒ…
- ç»Ÿè®¡ç©ºé—²ç«¯å£æ•°é‡

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "æµ‹è¯•æµç¨‹å®Œæˆ",
  "summary": {
    "totalDevices": 10,
    "targetDevices": 3,
    "totalZeroPorts": 8
  },
  "deviceDetails": [
    {
      "name": "ä¸­ç”µé‡‘ä¿¡è‡ªè¡Œè½¦å……ç”µ1å·æ¡©",
      "simId": "867997075125699",
      "totalPorts": 21,
      "zeroPorts": 3,
      "errorMsg": "è®¾å¤‡ç»´æŠ¤ä¸­"
    }
  ]
}
```

## æ ¸å¿ƒå‡½æ•°

### getNearbyDevices(params)

è·å–é™„è¿‘å……ç”µæ¡©åˆ—è¡¨ã€‚

**å‚æ•°ï¼š**
- `params: NearbyDevicesRequest` - æŸ¥è¯¢å‚æ•°

**è¿”å›ï¼š**
- `Promise<ChargingDevice[]>` - å……ç”µæ¡©åˆ—è¡¨

### getDeviceDetail(params)

è·å–å……ç”µæ¡©è¯¦æƒ…ä¿¡æ¯ã€‚

**å‚æ•°ï¼š**
- `params: DeviceDetailRequest` - è¯¦æƒ…æŸ¥è¯¢å‚æ•°

**è¿”å›ï¼š**
- `Promise<ChargingDeviceDetail>` - å……ç”µæ¡©è¯¦æƒ…

## æµ‹è¯•æµç¨‹è¯´æ˜

æµ‹è¯•æµç¨‹å®Œæ•´å®ç°äº†ä»¥ä¸‹æ­¥éª¤ï¼š

1. **è·å–å……ç”µæ¡©åˆ—è¡¨**ï¼šä½¿ç”¨ç¤ºä¾‹åæ ‡è·å–é™„è¿‘å……ç”µæ¡©
2. **ç­›é€‰ç›®æ ‡å……ç”µæ¡©**ï¼šæ‰¾åˆ°åç§°åŒ…å«"ä¸­ç”µé‡‘ä¿¡"çš„å……ç”µæ¡©
3. **è·å–è¯¦æƒ…ä¿¡æ¯**ï¼šä¾æ¬¡è¯·æ±‚æ¯ä¸ªç›®æ ‡å……ç”µæ¡©çš„è¯¦æƒ…
4. **ç»Ÿè®¡ç©ºé—²ç«¯å£**ï¼šè®¡ç®— `ports` æ•°ç»„ä¸­å€¼ä¸º 0 çš„å…ƒç´ æ•°é‡

### ç«¯å£çŠ¶æ€è¯´æ˜

- `0`: ç©ºé—²/å¯ç”¨ç«¯å£
- `1`: å ç”¨/ä¸å¯ç”¨ç«¯å£

## å¼€å‘è¯´æ˜

### TypeScript ç±»å‹ç³»ç»Ÿ

é¡¹ç›®é‡‡ç”¨å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰ï¼š

- `ChargingDevice`: å……ç”µæ¡©è®¾å¤‡ä¿¡æ¯
- `ChargingDeviceDetail`: å……ç”µæ¡©è¯¦æƒ…ä¿¡æ¯
- `ApiResponse`: API å“åº”æ ¼å¼
- `NearbyDevicesRequest`: é™„è¿‘è®¾å¤‡æŸ¥è¯¢å‚æ•°
- `DeviceDetailRequest`: è®¾å¤‡è¯¦æƒ…æŸ¥è¯¢å‚æ•°

### é”™è¯¯å¤„ç†

- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯è¿”å›
- HTTP çŠ¶æ€ç è§„èŒƒ

### CORS æ”¯æŒ

æ‰€æœ‰æ¥å£å‡æ”¯æŒè·¨åŸŸè¯·æ±‚ï¼Œä¾¿äºå‰ç«¯é›†æˆã€‚

## è®¸å¯è¯

ISC License

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-01)

- âœ… åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… å®ç°å……ç”µæ¡©åˆ—è¡¨æŸ¥è¯¢
- âœ… å®ç°å……ç”µæ¡©è¯¦æƒ…æŸ¥è¯¢
- âœ… å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
- âœ… æµ‹è¯•æµç¨‹å®ç°
- âœ… Cloudflare Workers éƒ¨ç½²é…ç½®