# 空闲提醒回溯脚本

## 快速开始

```bash
# 回溯某天的空闲检测情况
pnpm backtest 2025-11-11

# 回溯某个具体时间点
pnpm backtest "2025-11-11 14:30"
```

## 功能说明

这个脚本用于回溯分析历史数据，验证空闲提醒功能在过去某个时间点的工作情况。

**特点：**
- ✅ Dry-run 模式，不发送通知，不修改数据库
- ✅ 完整模拟检测流程（配置检查、时间窗口、工作日、空闲检测、去重）
- ✅ 输出详细的分析报告
- ✅ 适合调试、测试配置、分析历史数据

## 输出示例

```
========== 空闲提醒回溯分析 ==========

📅 回溯日期: 2025-11-11 14:30:00

--- 步骤 1: 读取配置 ---
配置信息: {
  enabled: '✅ 已启用',
  threshold: '5 分钟',
  timeRange: '00:00 - 23:59',
  webhookCount: 1,
  stationFilter: '监控所有充电桩'
}

--- 步骤 2: 检查时间窗口 ---
✅ 在时间窗口内 (14:30)

--- 步骤 3: 检查工作日 ---
✅ 工作日

--- 步骤 4: 检测空闲插座 ---
找到 3 个在线充电桩

--- 回溯结果统计 ---
在线充电桩: 3 个
空闲插座总数: 15 个
应发送提醒: 8 个
跳过提醒: 7 个

--- 详细列表 ---

✅ 应发送提醒的插座:
  - 1号充电桩 插座9: 空闲 218 分钟 (自 2025-11-11 12:39:49)
  - 1号充电桩 插座6: 空闲 464 分钟 (自 2025-11-11 14:33:49)
  ...

⏭️  跳过提醒的插座:
  - 2号充电桩 插座3: 未达到阈值 (3/5分钟) (空闲 3 分钟)
  - 3号充电桩 插座5: 当天已提醒过 (空闲 120 分钟)
  ...

========================================
```

## 详细文档

完整的使用指南和故障排查，请参阅：[回溯指南](../docs/backtest-guide.md)

## 常见问题

### Q: 为什么本地运行没有数据？

A: 本地数据库只有表结构，没有线上的充电桩数据。你可以：

1. 使用 `wrangler d1 execute --remote` 直接查询线上数据
2. 导出线上数据到本地：`wrangler d1 export ... --remote --output backup.sql`

### Q: 如何查看线上真实数据？

A: 使用以下命令直接查询远程数据库：

```bash
# 查看某天的空闲事件
npx wrangler d1 execute gaotu-electric-bike-charging-pile-db --remote \
  --command "SELECT station_id, socket_id, COUNT(*) as cnt
             FROM status_events
             WHERE date(timestamp/1000, 'unixepoch', '+8 hours') = '2025-11-11'
               AND new_status = 'available'
             GROUP BY station_id, socket_id"
```

### Q: 脚本会发送真实的通知吗？

A: 不会。脚本运行在 **dry-run 模式**，只分析数据，不发送 Webhook，也不写入提醒日志。
